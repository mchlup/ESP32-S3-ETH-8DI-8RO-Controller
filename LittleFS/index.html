<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32-S3 Topný systém</title>
  <link rel="stylesheet" href="/css/app.css" />
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <button class="icon-btn" id="navToggle" aria-label="Otevřít navigaci">☰</button>
      <div class="brand">
        <div class="title">ESP32-S3 Topný systém</div>
        <div class="subtitle">Web UI – konfigurace a diagnostika</div>
      </div>
      <div class="status-strip">
        <div class="status-pill" id="statusNetwork">Síť: —</div>
        <div class="status-pill" id="statusMqtt">MQTT: —</div>
        <div class="status-pill" id="statusBle">BLE: —</div>
        <div class="status-pill" id="statusMode">Režim: —</div>
      </div>
      <div class="top-actions">
        <button class="btn" id="refreshNow">Refresh</button>
        <button class="btn secondary" id="pausePolling">Pozastavit</button>
      </div>
    </header>

    <aside class="sidebar" id="sidebar">
      <nav class="nav">
        <a href="#dashboard">Dashboard</a>
        <a href="#equitherm">Ekviterm</a>
        <a href="#tuv">TUV / DHW</a>
        <a href="#io">Vstupy & Výstupy</a>
        <a href="#valves">Ventily (3c)</a>
        <a href="#thermometers">Teploměry</a>
        <a href="#ble">BLE</a>
        <a href="#buzzer">Buzzer</a>
        <a href="#advanced">Pokročilé</a>
      </nav>
    </aside>

    <main class="content">
      <section id="dashboard" class="section">
        <h1>Dashboard (Provoz)</h1>
        <div class="grid cards">
          <div class="card">
            <h2>Režim</h2>
            <div class="stack">
              <div id="dashMode">—</div>
              <div class="inline">
                <button class="btn" id="setAuto">AUTO</button>
                <button class="btn secondary" id="setManual">MANUAL</button>
              </div>
              <label class="field">
                <span>Manuální režim</span>
                <select id="manualModeSelect"></select>
              </label>
            </div>
          </div>
          <div class="card">
            <h2>Ekviterm</h2>
            <div class="stack">
              <div id="dashEquitherm">—</div>
              <div class="metric-grid">
                <div><span class="label">Outdoor</span><span id="eqOutdoor">—</span></div>
                <div><span class="label">Target flow</span><span id="eqTarget">—</span></div>
                <div><span class="label">Flow</span><span id="eqFlow">—</span></div>
                <div><span class="label">Ventil</span><span id="eqValve">—</span></div>
              </div>
            </div>
          </div>
          <div class="card">
            <h2>TUV / DHW</h2>
            <div class="stack">
              <div id="dashTuv">—</div>
              <div class="metric-grid">
                <div><span class="label">Demand</span><span id="tuvDemand">—</span></div>
                <div><span class="label">Relé</span><span id="tuvRelay">—</span></div>
                <div><span class="label">Ventil</span><span id="tuvValve">—</span></div>
              </div>
            </div>
          </div>
          <div class="card">
            <h2>Relé (1–8)</h2>
            <div id="relayGrid" class="relay-grid"></div>
            <p class="hint">Kliknutí přepne relé do MANUAL.</p>
          </div>
          <div class="card">
            <h2>Vstupy (1–8)</h2>
            <div id="inputGrid" class="input-grid"></div>
          </div>
          <div class="card">
            <h2>Teploty TEMP1..8</h2>
            <div id="tempGrid" class="temp-grid"></div>
          </div>
          <div class="card">
            <h2>BLE Meteo senzor</h2>
            <div class="metric-grid">
              <div><span class="label">Teplota</span><span id="bleMeteoTemp">—</span></div>
              <div><span class="label">Fix</span><span id="bleMeteoFix">—</span></div>
              <div><span class="label">Age</span><span id="bleMeteoAge">—</span></div>
            </div>
          </div>
          <div class="card">
            <h2>Diagnostika</h2>
            <div class="metric-grid">
              <div><span class="label">Heap free</span><span id="heapFree">—</span></div>
              <div><span class="label">Heap min</span><span id="heapMin">—</span></div>
              <div><span class="label">Heap largest</span><span id="heapLargest">—</span></div>
            </div>
          </div>
        </div>
      </section>

      <section id="equitherm" class="section" data-cap="equitherm">
        <h1>Ekviterm</h1>
        <div class="grid two">
          <div class="card">
            <h2>Zapnutí a stav</h2>
            <label class="toggle">
              <input type="checkbox" data-path="equitherm.enabled" />
              <span>Enabled</span>
            </label>
            <div class="status-box" id="eqStatus">—</div>
            <div class="stack">
              <label class="field">
                <span>Valve master relé (1–8)</span>
                <input type="number" min="0" max="8" data-path="equitherm.valveMaster" />
              </label>
              <label class="field">
                <span>Curve offset °C</span>
                <input type="number" step="0.1" data-path="equitherm.curveOffsetC" />
              </label>
            </div>
          </div>
          <div class="card">
            <h2>Teplotní zdroje</h2>
            <div id="eqSources" class="stack"></div>
          </div>
        </div>
        <div class="grid two">
          <div class="card">
            <h2>Křivka a limity (Day/Night)</h2>
            <div class="form-grid">
              <label class="field"><span>Min flow °C</span><input type="number" step="0.1" data-path="equitherm.minFlow" /></label>
              <label class="field"><span>Max flow °C</span><input type="number" step="0.1" data-path="equitherm.maxFlow" /></label>
              <label class="field"><span>Slope day</span><input type="number" step="0.01" data-path="equitherm.slopeDay" /></label>
              <label class="field"><span>Shift day</span><input type="number" step="0.1" data-path="equitherm.shiftDay" /></label>
              <label class="field"><span>Slope night</span><input type="number" step="0.01" data-path="equitherm.slopeNight" /></label>
              <label class="field"><span>Shift night</span><input type="number" step="0.1" data-path="equitherm.shiftNight" /></label>
              <label class="field"><span>Max pct day</span><input type="number" min="0" max="100" data-path="equitherm.maxPct_day" /></label>
              <label class="field"><span>Max pct night</span><input type="number" min="0" max="100" data-path="equitherm.maxPct_night" /></label>
              <label class="field"><span>Ref day Tout1</span><input type="number" step="0.1" data-path="equitherm.refs.day.tout1" /></label>
              <label class="field"><span>Ref day Tflow1</span><input type="number" step="0.1" data-path="equitherm.refs.day.tflow1" /></label>
              <label class="field"><span>Ref day Tout2</span><input type="number" step="0.1" data-path="equitherm.refs.day.tout2" /></label>
              <label class="field"><span>Ref day Tflow2</span><input type="number" step="0.1" data-path="equitherm.refs.day.tflow2" /></label>
              <label class="field"><span>Ref night Tout1</span><input type="number" step="0.1" data-path="equitherm.refs.night.tout1" /></label>
              <label class="field"><span>Ref night Tflow1</span><input type="number" step="0.1" data-path="equitherm.refs.night.tflow1" /></label>
              <label class="field"><span>Ref night Tout2</span><input type="number" step="0.1" data-path="equitherm.refs.night.tout2" /></label>
              <label class="field"><span>Ref night Tflow2</span><input type="number" step="0.1" data-path="equitherm.refs.night.tflow2" /></label>
            </div>
            <div class="chart-wrap">
              <canvas id="eqCurve" width="320" height="180"></canvas>
            </div>
          </div>
          <div class="card">
            <h2>Řízení</h2>
            <div class="form-grid">
              <label class="field"><span>Deadband °C</span><input type="number" step="0.1" data-path="equitherm.deadbandC" /></label>
              <label class="field"><span>Step %</span><input type="number" min="0" max="100" data-path="equitherm.stepPct" /></label>
              <label class="field"><span>Control period ms</span><input type="number" min="0" data-path="equitherm.controlPeriodMs" /></label>
              <label class="field"><span>Max boiler in °C</span><input type="number" step="0.1" data-path="equitherm.maxBoilerInC" /></label>
              <label class="field"><span>No-flow enabled</span><input type="checkbox" data-path="equitherm.noFlowDetectEnabled" /></label>
              <label class="field"><span>No-flow timeout ms</span><input type="number" min="0" data-path="equitherm.noFlowTimeoutMs" /></label>
              <label class="field"><span>No-flow test period ms</span><input type="number" min="0" data-path="equitherm.noFlowTestPeriodMs" /></label>
            </div>
            <div class="action-bar">
              <button class="btn primary" data-save="equitherm">Uložit ekviterm</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tuv" class="section" data-cap="tuv">
        <h1>TUV / DHW</h1>
        <div class="grid two">
          <div class="card">
            <h2>Základ</h2>
            <label class="toggle">
              <input type="checkbox" data-path="tuv.enabled" />
              <span>Enabled</span>
            </label>
            <div class="form-grid">
              <label class="field"><span>Relé požadavku (relay)</span><input type="number" min="0" max="8" data-path="tuv.relay" /></label>
              <label class="field"><span>Relé požadavku (requestRelay)</span><input type="number" min="0" max="8" data-path="tuv.requestRelay" /></label>
              <label class="field"><span>Demand input</span><input type="number" min="0" max="8" data-path="tuv.demandInput" /></label>
              <label class="field"><span>Restore eq valve after</span><input type="number" min="0" data-path="tuv.restoreEqValveAfter" /></label>
            </div>
          </div>
          <div class="card">
            <h2>Ventil TUV</h2>
            <div class="form-grid">
              <label class="field"><span>Valve master</span><input type="number" min="0" max="8" data-path="tuv.valveMaster" /></label>
              <label class="field"><span>Short valve master</span><input type="number" min="0" max="8" data-path="tuv.shortValveMaster" /></label>
              <label class="field"><span>Target %</span><input type="number" min="0" max="100" data-path="tuv.targetPct" /></label>
              <label class="field"><span>Valve target %</span><input type="number" min="0" max="100" data-path="tuv.valveTargetPct" /></label>
              <label class="field"><span>EQ valve target %</span><input type="number" min="0" max="100" data-path="tuv.eqValveTargetPct" /></label>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Bypass ventil</h2>
          <label class="toggle">
            <input type="checkbox" data-path="tuv.bypassValve.enabled" />
            <span>Enabled</span>
          </label>
          <div class="form-grid">
            <label class="field"><span>Master relay</span><input type="number" min="0" max="8" data-path="tuv.bypassValve.masterRelay" /></label>
            <label class="field"><span>Bypass %</span><input type="number" min="0" max="100" data-path="tuv.bypassValve.bypassPct" /></label>
            <label class="field"><span>CH %</span><input type="number" min="0" max="100" data-path="tuv.bypassValve.chPct" /></label>
            <label class="field"><span>Invert</span><input type="checkbox" data-path="tuv.bypassValve.invert" /></label>
          </div>
          <div class="action-bar">
            <button class="btn primary" data-save="tuv">Uložit TUV</button>
          </div>
        </div>
      </section>

      <section id="io" class="section">
        <h1>Vstupy & Výstupy</h1>
        <div class="grid two">
          <div class="card">
            <h2>Názvy vstupů + aktivní úrovně</h2>
            <div id="inputConfig" class="stack"></div>
            <div class="inline">
              <button class="btn secondary" id="inputsAllHigh">Vše HIGH</button>
              <button class="btn secondary" id="inputsAllLow">Vše LOW</button>
            </div>
          </div>
          <div class="card">
            <h2>Názvy relé</h2>
            <div id="relayNames" class="stack"></div>
          </div>
        </div>
        <div class="card">
          <h2>Mapování vstup → relé (AUTO)</h2>
          <div id="relayMap" class="stack"></div>
          <label class="toggle">
            <input type="checkbox" data-path="autoDefaultOffUnmapped" />
            <span>Auto default OFF pro ne-mapovaná relé</span>
          </label>
          <div class="action-bar">
            <button class="btn" id="autoRecompute">Recompute now</button>
            <button class="btn primary" data-save="relay">Uložit mapování</button>
          </div>
        </div>
        <div class="card">
          <h2>IO role (iofunc)</h2>
          <div class="grid two">
            <div>
              <h3>Vstupy</h3>
              <div id="iofuncInputs" class="stack"></div>
            </div>
            <div>
              <h3>Výstupy</h3>
              <div id="iofuncOutputs" class="stack"></div>
            </div>
          </div>
          <div class="action-bar">
            <button class="btn primary" data-save="iofunc">Uložit role</button>
          </div>
        </div>
      </section>

      <section id="valves" class="section">
        <h1>Ventily (3c)</h1>
        <div class="card">
          <h2>Nastavení ventilů (iofunc.outputs)</h2>
          <div id="valveConfig" class="stack"></div>
          <div class="action-bar">
            <button class="btn primary" data-save="valves">Uložit ventily</button>
          </div>
        </div>
        <div class="card">
          <h2>Kalibrace ventilů</h2>
          <p class="hint">Manuální testy mohou přepnout jednotku do MANUAL.</p>
          <div class="grid two">
            <div>
              <label class="field"><span>Master relé</span><input type="number" min="1" max="8" id="calMaster" /></label>
              <label class="field"><span>Peer relé</span><input type="number" min="1" max="8" id="calPeer" /></label>
              <label class="field"><span>Invert dir</span><input type="checkbox" id="calInvert" /></label>
              <label class="field"><span>Travel time (s)</span><input type="number" min="0" id="calTravel" /></label>
              <label class="field"><span>Pulse time (s)</span><input type="number" min="0" id="calPulse" /></label>
              <label class="field"><span>Guard time (s)</span><input type="number" min="0" id="calGuard" /></label>
              <label class="field"><span>Min switch (s)</span><input type="number" min="0" id="calMinSwitch" /></label>
              <label class="field"><span>Default pos</span>
                <select id="calDefault">
                  <option value="A">A</option>
                  <option value="B">B</option>
                </select>
              </label>
              <div class="inline">
                <button class="btn" id="testRelayA">Test A</button>
                <button class="btn" id="testRelayB">Test B</button>
                <button class="btn secondary" id="stopRelay">Stop</button>
              </div>
            </div>
            <div>
              <div class="status-box" id="calStatus">—</div>
              <button class="btn primary" id="saveCalibration">Uložit do configu</button>
            </div>
          </div>
        </div>
      </section>

      <section id="thermometers" class="section">
        <h1>Teploměry (DS18B20 / MQTT / BLE)</h1>
        <div class="grid two">
          <div class="card">
            <h2>MQTT sloty</h2>
            <div id="mqttThermometers" class="stack"></div>
          </div>
          <div class="card">
            <h2>BLE teploměr</h2>
            <div id="bleThermometer" class="stack"></div>
          </div>
        </div>
        <div class="card">
          <h2>DS18B20 diagnostika</h2>
          <div id="dallasDiag" class="stack"></div>
        </div>
        <div class="action-bar">
          <button class="btn primary" data-save="thermometers">Uložit teploměry</button>
        </div>
      </section>

      <section id="ble" class="section" data-cap="ble">
        <h1>BLE</h1>
        <div class="grid two">
          <div class="card">
            <h2>Konfigurace</h2>
            <div id="bleConfig" class="stack"></div>
            <div class="action-bar">
              <button class="btn primary" id="saveBleConfig">Uložit BLE</button>
            </div>
          </div>
          <div class="card">
            <h2>Párování & Allowlist</h2>
            <div class="stack">
              <label class="field"><span>Role</span>
                <select id="blePairRole">
                  <option value="meteo">Meteo</option>
                  <option value="display">Display</option>
                  <option value="other">Other</option>
                </select>
              </label>
              <label class="field"><span>Seconds</span><input type="number" min="5" max="600" id="blePairSeconds" value="120" /></label>
              <div class="inline">
                <button class="btn" id="blePairStart">Start pairing</button>
                <button class="btn secondary" id="blePairStop">Stop</button>
              </div>
            </div>
            <h3>Paired zařízení</h3>
            <div id="blePaired" class="stack"></div>
            <div class="action-bar">
              <button class="btn" id="bleRetry">Retry meteo now</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>BLE status</h2>
          <pre id="bleStatus" class="code-block">—</pre>
        </div>
      </section>

      <section id="buzzer" class="section" data-cap="buzzer">
        <h1>Buzzer</h1>
        <div class="grid two">
          <div class="card">
            <h2>Konfigurace</h2>
            <div id="buzzerConfig" class="stack"></div>
            <div class="action-bar">
              <button class="btn primary" id="saveBuzzer">Uložit buzzer</button>
            </div>
          </div>
          <div class="card">
            <h2>Test patternů</h2>
            <div id="buzzerTests" class="inline wrap"></div>
            <button class="btn secondary" id="buzzerStop">Stop</button>
          </div>
        </div>
      </section>

      <section id="advanced" class="section">
        <h1>Pokročilé</h1>
        <div class="grid two">
          <div class="card">
            <h2>Import / Export konfigurace</h2>
            <div class="stack">
              <button class="btn" id="exportConfig">Export config.json</button>
              <label class="field">
                <span>Import JSON</span>
                <input type="file" id="importConfig" accept="application/json" />
              </label>
              <textarea id="configPreview" class="code-block" rows="10" readonly></textarea>
              <button class="btn primary" id="applyImport">Použít import</button>
            </div>
          </div>
          <div class="card">
            <h2>BLE / Buzzer export</h2>
            <div class="stack">
              <button class="btn" id="exportBle">Export BLE config</button>
              <button class="btn" id="exportBuzzer">Export Buzzer config</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Diagnostika</h2>
          <pre id="capsDump" class="code-block"></pre>
          <pre id="statusDump" class="code-block"></pre>
        </div>
        <div class="card danger">
          <h2>Reboot zařízení</h2>
          <p>Vyžaduje potvrzení.</p>
          <button class="btn danger" id="reboot">Reboot</button>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="/js/app.js"></script>
</body>
</html>
