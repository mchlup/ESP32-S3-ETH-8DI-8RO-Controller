<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP Heat Controller</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/dash_v2.css" />
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <div class="logo" aria-hidden="true">‚ü°</div>
        <div class="brandTxt">
          <div class="brandTitle">Heat Controller</div>
          <div class="brandSub" id="brandSub">‚Äî</div>
        </div>
      </div>

      <nav class="nav" aria-label="Navigace">
        <button class="navItem active" data-page="dash">
          <span class="ico">‚åÅ</span><span>P≈ôehled</span>
        </button>
        <button class="navItem" data-page="config">
          <span class="ico">‚öô</span><span>Konfigurace</span>
        </button>
        <button class="navItem" data-page="config" data-ctab="ekviterm">
          <span class="ico">üìà</span><span>Ekviterm</span>
        </button>
        <button class="navItem" data-page="mqtt">
          <span class="ico">‚áÑ</span><span>MQTT / HA</span>
        </button>
        <button class="navItem" data-page="ble">
          <span class="ico">‚åÇ</span><span>BLE</span>
        </button>
        <button class="navItem" data-page="rules">
          <span class="ico">‚ü∞</span><span>Rule engine</span>
        </button>
        <button class="navItem" data-page="files">
          <span class="ico">‚ßâ</span><span>LittleFS</span>
        </button>
        <button class="navItem" data-page="system">
          <span class="ico">‚ü≤</span><span>Syst√©m</span>
        </button>
        <button class="navItem" data-page="ota"><span class="ico">‚§í</span><span>OTA update</span></button>
      </nav>

      <div class="sideFooter">
        <div class="chips">
          <span class="chip" id="chipWifi">Wi‚ÄëFi: ‚Äî</span>
          <span class="chip" id="chipMqtt">MQTT: ‚Äî</span>
        </div>
        <button class="ghost" id="btnTheme" title="P≈ôepnout motiv">Motiv</button>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topLeft">
          <div class="h1">≈ò√≠dic√≠ panel</div>
          <div class="muted" id="topHint">Naƒç√≠t√°m‚Ä¶</div>
        </div>
        <div class="topRight">
          <div class="pill" id="pillIp">IP: ‚Äî</div>
          <div class="pill" id="pillUptime">uptime: ‚Äî</div>
        </div>
      </header>

      <section class="page active" id="page-dash">
        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Re≈æimy</div>
                <div class="muted">≈ò√≠zen√≠ AUTO / MANUAL a aktivn√≠ re≈æim</div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>Control mode</label>
                <select id="selControlMode">
                  <option value="auto">AUTO</option>
                  <option value="manual">MANUAL</option>
                </select>
              </div>
              <div class="field">
                <label>Aktivn√≠ re≈æim</label>
                <select id="selSystemMode"></select>
              </div>
              <div class="field">
                <label>Akce</label>
                <div class="btnRow">
                  <button class="btn" id="btnApplyMode">Pou≈æ√≠t</button>
                  <button class="btn ghost" id="btnAutoRecompute" title="P≈ôepoƒç√≠tat AUTO podle vstup≈Ø">AUTO p≈ôepoƒç√≠tat</button>
                </div>
              </div>
            </div>

            <div class="split">
              <div class="kv">
                <div class="k">SystemMode</div><div class="v" id="kvSystemMode">‚Äî</div>
                <div class="k">ControlMode</div><div class="v" id="kvControlMode">‚Äî</div>
                <div class="k">RSSI</div><div class="v" id="kvRssi">‚Äî</div>
              </div>

              <div class="kv">
                <div class="k">BLE</div><div class="v" id="kvBle">‚Äî</div>
                <div class="k">P√°rov√°n√≠</div><div class="v" id="kvPairing">‚Äî</div>
                <div class="k">Meteo</div><div class="v" id="kvMeteo">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="card" id="cardEquitherm" style="display:none">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Ekviterm</div>
                <div class="muted">Venkovn√≠ teplota + stav trojcestn√©ho ventilu pro ekvitermn√≠ ≈ô√≠zen√≠</div>
              </div>
            </div>
            <div class="ioGrid" id="eqDashGrid"></div>
          </div>

      <div class="card" id="cardValves" style="display:none">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Trojcestn√© ventily</div>
            <div class="muted">Pozice 0‚Äì100 %, indikace pohybu; kliknut√≠ p≈ôepne A/B (v MANUAL)</div>
          </div>
        </div>
        <div class="ioGrid" id="valveGrid"></div>
      </div>

      <div class="card" id="cardTemps" style="display:none">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Teploty</div>
            <div class="muted">Posledn√≠ namƒõ≈ôen√© teploty pro vstupy s rol√≠ teplomƒõru (NTC / Dallas)</div>
          </div>
        </div>
        <div class="ioGrid" id="tempGrid"></div>
      </div>
<div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Rel√©</div>
                <div class="muted">Kliknut√≠m zapne≈°/vypne≈° rel√© (v MANUAL)</div>
              </div>
              <div class="right">
                <span class="badge" id="badgeControl">‚Äî</span>
              </div>
            </div>

            <div class="ioGrid" id="relayGrid"></div>
          </div>
        </div>

        <div class="card">
          <div class="cardHead">
            <div>
              <div class="cardTitle">Vstupy</div>
              <div class="muted">Stav vstup≈Ø (logick√Ω stav podle activeLevel)</div>
            </div>
          </div>
          <div class="ioGrid" id="inputGrid"></div>
        </div>
      </section>

      <section class="page" id="page-config">
        <div class="tabs">
          <button class="tab active" data-ctab="io">Vstupy & rel√©</button>
          <button class="tab" data-ctab="modes">Re≈æimy</button>
          <button class="tab" data-ctab="ekviterm">Ekviterm</button>
          <button class="tab" data-ctab="opentherm">OpenTherm</button>
          <button class="tab" data-ctab="iofun">Funkce I/O</button>
          <button class="tab" data-ctab="tempscfg">Teplomƒõry</button>

                    <button class="tab" data-ctab="valvecal">Kalibrace ventil≈Ø</button>
          <button class="tab" data-ctab="time">ƒåas & NTP</button>
          <button class="tab" data-ctab="sched">Pl√°nov√°n√≠</button>
<button class="tab" data-ctab="buzzer">Buzzer</button>
          <button class="tab" data-ctab="json">Advanced JSON</button>
        </div>

        <div class="tabPage active" id="cfg-io">
          <div class="grid2">
            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Vstupy</div>
                  <div class="muted">N√°zvy + aktivn√≠ √∫rove≈à (LOW/HIGH)</div>
                </div>
                <button class="btn" id="btnSaveInputs">Ulo≈æit</button>
              </div>
              <div class="table" id="tblInputs"></div>
            </div>

            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Rel√©</div>
                  <div class="muted">N√°zvy + mapov√°n√≠ pro AUTO</div>
                </div>
                <button class="btn" id="btnSaveRelays">Ulo≈æit</button>
              </div>
              <div class="table" id="tblRelays"></div>
            </div>
          </div>
        </div>

        <div class="tabPage" id="cfg-modes">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Re≈æimy (MODE1..MODE5)</div>
                <div class="muted">Ka≈æd√Ω re≈æim: n√°zev, popis, trigger vstup a stavy rel√©</div>
              </div>
              <button class="btn" id="btnSaveModes">Ulo≈æit</button>
            </div>
            <div class="modeGrid" id="modesGrid"></div>
          </div>
        </div>
        
                
        <div class="tabPage" id="cfg-tempscfg">
          <div class="grid2">
            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Teplomƒõry (Dallas DS18B20)</div>
                  <div class="muted">DS18B20 na pin headeru: pevn√© mapov√°n√≠ Teplomƒõr 1‚Äì4 = GPIO0‚Äì3. Neovliv≈àuje konfiguraci ‚ÄûFunkce I/O‚Äú. (Adresa je voliteln√° ‚Äì jinak se pou≈æije prvn√≠ senzor na sbƒõrnici.)</div>
                </div>
                <button class="btn" id="btnSaveTempsCfg">Ulo≈æit</button>
              </div>
              <div class="table" id="tblTempsCfg"></div>
            </div>

            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Teplomƒõry (MQTT/BLE)</div>
                  <div class="muted">Dva MQTT teplomƒõry s mo≈ænost√≠ parsov√°n√≠ jednoduch√©ho JSON + jeden BLE teplomƒõr. Zobrazuj√≠ se spoleƒçnƒõ s Dallas teplomƒõry ve volb√°ch nap≈ô√≠ƒç syst√©mem (nap≈ô. Ekviterm).</div>
                </div>
              </div>
              <div class="table" id="tblExtraTempsCfg"></div>
              <div class="pad" style="padding-top:8px">
                <div class="muted" style="font-size:12px">Tip: MQTT payload m≈Ø≈æe b√Ωt ƒç√≠slo (nap≈ô. <code>21.5</code>) nebo JSON (nap≈ô. <code>{"tempC":21.5}</code>). Do <b>jsonKey</b> m≈Ø≈æe≈° zadat i cestu (nap≈ô. <code>sensor.tempC</code>).</div>
              </div>
            </div>

            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Diagnostika</div>
                  <div class="muted">Hodnoty jsou ƒçten√© z /api/dash (index odpov√≠d√° vstupu 1‚Äì8).</div>
                </div>
              </div>
                            <div class="kv">
                <div class="k">Aktualizace</div><div class="v" id="tempsLastUpd">‚Äî</div>
              </div>
              <div style="height:10px"></div>
              <div class="muted">Dallas diagnostika (GPIO0‚Äì3): stav sbƒõrnice, nalezen√° ƒçidla, ROM a teploty.</div>
              <div class="table" id="tblDallasDiag"></div>
              <div style="height:10px"></div>
              <div class="muted">MQTT/BLE diagnostika: posledn√≠ namƒõ≈ôen√° hodnota a st√°≈ô√≠ dat (pokud jsou k dispozici).</div>
              <div class="table" id="tblExtraTempsDiag"></div>
            </div>


          </div>
        </div>

        <div class="tabPage" id="cfg-valvecal">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Kalibrace trojcestn√Ωch ventil≈Ø</div>
                <div class="muted">Pomocn√© n√°stroje pro zmƒõ≈ôeni doby p≈ôebƒõhu (sekundy) a ulo≈æen√≠ do ≈°ablony v√Ωstupu. Pou≈æ√≠v√° ovl√°d√°n√≠ rel√© p≈ôes /api/mode_ctrl.</div>
              </div>
              <div class="actions">
                <button class="btn" id="btnSaveValveCalib">Ulo≈æit</button>
              </div>
            </div>
            <div class="pad">
              <div class="muted" style="margin-bottom:10px">
                Zobraz√≠ se pouze rel√© s rol√≠ <b>Trojcestn√Ω ventil 2‚Äëbod</b> (ve ‚ÄûFunkce I/O‚Äú). Tlaƒç√≠tko <b>Start mƒõ≈ôen√≠</b> sepne rel√© a spust√≠ stopky, <b>Stop</b> rel√© vypne a ulo≈æ√≠ namƒõ≈ôen√Ω ƒças jako ‚ÄûDoba p≈ôebƒõhu‚Äú.
              </div>
              <div class="table" id="tblValveCalib"></div>
            </div>
          </div>
        </div>
        <div class="tabPage" id="cfg-time">
          <div class="grid2">
            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">ƒåas & NTP</div>
                  <div class="muted">Konfigurace synchronizace ƒçasu (NTP). ƒåas je z√°klad pro ƒçasov√© funkce (pl√°nov√°n√≠ re≈æim≈Ø, oh≈ôev TUV, noƒçn√≠ √∫tlum‚Ä¶)</div>
                </div>
                <button class="btn" id="btnSaveTime">Ulo≈æit</button>
              </div>
              <div class="pad">
                <label class="check"><input type="checkbox" id="ntpEnabled"> <span>Povolit NTP</span></label>
                <div class="grid2" style="margin-top:10px">
                  <div class="field">
                    <label>NTP server 1</label>
                    <input id="ntpServer1" type="text" placeholder="pool.ntp.org">
                  </div>
                  <div class="field">
                    <label>NTP server 2</label>
                    <input id="ntpServer2" type="text" placeholder="time.google.com">
                  </div>
                </div>
                <div class="grid2">
                  <div class="field">
                    <label>Time zone (IANA)</label>
                    <input id="ntpTz" type="text" placeholder="Europe/Prague">
                  </div>
                  <div class="field">
                    <label>Interval synchronizace (min)</label>
                    <input id="ntpIntervalMin" type="number" step="1" min="5" max="1440">
                  </div>
                </div>
                <div class="divider"></div>
                <div class="row">
                  <button class="btn ghost" id="btnTryReadTime">Naƒç√≠st ƒças ze za≈ô√≠zen√≠</button>
                </div>
                <div class="muted" id="timeInfo" style="margin-top:8px">‚Äî</div>
              </div>
            </div>

            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Stav ƒçasu</div>
                  <div class="muted">Browser ƒças je v≈ædy dostupn√Ω. Pokud firmware poskytuje /api/time, zobraz√≠ se i ƒças za≈ô√≠zen√≠.</div>
                </div>
              </div>
              <div class="pad">
                <div class="grid2">
                  <div class="card mini">
                    <div class="muted">ƒåas v prohl√≠≈æeƒçi</div>
                    <div class="bigNum" id="browserTime">‚Äî</div>
                  </div>
                  <div class="card mini">
                    <div class="muted">ƒåas za≈ô√≠zen√≠</div>
                    <div class="bigNum" id="deviceTime">‚Äî</div>
                  </div>
                </div>
                <div class="muted" style="margin-top:10px">Tip: Pokud zat√≠m firmware /api/time nem√°, UI nespadne ‚Äì jen uk√°≈æe ‚Äû‚Äî‚Äú.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="tabPage" id="cfg-sched">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Pl√°nov√°n√≠</div>
                <div class="muted">ƒåasov√° pravidla ulo≈æen√° do konfigurace. Firmware je m≈Ø≈æe pozdƒõji vyhodnocovat (p≈ôep√≠n√°n√≠ re≈æim≈Ø, noƒçn√≠ √∫tlum, oh≈ôev TUV‚Ä¶).</div>
              </div>
              <div class="actions">
                <button class="btn ghost" id="btnAddSchedule">P≈ôidat</button>
                <button class="btn" id="btnSaveSchedules">Ulo≈æit</button>
              </div>
            </div>
            <div class="pad">
              <div class="table" id="tblSchedules"></div>
            </div>
          </div>
        </div>

<div class="tabPage" id="cfg-buzzer">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">BUZZER</div>
                <div class="muted">GPIO46 ‚Äì syst√©mov√© ud√°losti + test p√≠pnut√≠</div>
              </div>
              <button class="btn" id="btnBuzzerSave">Ulo≈æit</button>
            </div>
            <div class="grid2">
              <div>
                <label class="check"><input type="checkbox" id="bzEnabled"> <span>Povolit buzzer</span></label>
                <div class="row" style="padding:0 14px 14px">
                  <div class="field">
                    <label>Aktivn√≠ √∫rove≈à</label>
                    <select id="bzActive">
                      <option value="high">HIGH = zapnuto</option>
                      <option value="low">LOW = zapnuto</option>
                    </select>
                  </div>
                </div>
                <div class="muted" style="padding:0 14px">Syst√©mov√© ud√°losti:</div>
                <div class="table" id="bzEvents"></div>
              </div>
              <div>
                <div class="muted" style="padding:14px 14px 0">Test:</div>
                <div class="row" style="gap:8px; flex-wrap:wrap">
                  <button class="btn" id="btnBeepShort">Kr√°tk√©</button>
                  <button class="btn" id="btnBeepLong">Dlouh√©</button>
                  <button class="btn" id="btnBeepDouble">Dvojit√©</button>
                  <button class="btn" id="btnBeepTriple">Trojit√©</button>
                  <button class="btn bad" id="btnBeepStop">Stop</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        
        
<div class="tabPage" id="cfg-ekviterm">
  <div class="grid2">
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Ekviterm</div>
          <div class="cardSub">Dynamick√° volba teplomƒõr≈Ø DS18B20 / MQTT / BLE + ≈ô√≠zen√≠ 3c ventilu (AUTO)</div>
        </div>
        <button class="btn" id="btnSaveEquitherm">Ulo≈æit</button>
      </div>

      <div class="ioGrid">
        <div class="ioRow">
          <div class="ioLabel">Povolit</div>
          <div class="ioValue"><label class="switch"><input id="eqEnabled" type="checkbox"><span class="slider"></span></label></div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Pozn√°mka</div>
          <div class="ioValue"><span class="hint">Ekviterm ≈ô√≠d√≠ ventil pouze v re≈æimu <b>≈ò√≠zen√≠ = AUTO</b>. V MANUAL jen poƒç√≠t√° c√≠lovou teplotu.</span></div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Venkovn√≠ teplota</div>
          <div class="ioValue">
            <select id="eqOutdoorSource">
              <option value="dallas">DS18B20 (Dallas)</option>
              <option value="temp1">Vstup TEMP1 (legacy)</option>
              <option value="temp2">Vstup TEMP2 (legacy)</option>
              <option value="temp3">Vstup TEMP3 (legacy)</option>
              <option value="temp4">Vstup TEMP4 (legacy)</option>
              <option value="temp5">Vstup TEMP5 (legacy)</option>
              <option value="temp6">Vstup TEMP6 (legacy)</option>
              <option value="temp7">Vstup TEMP7 (legacy)</option>
              <option value="temp8">Vstup TEMP8 (legacy)</option>
              <option value="mqtt">MQTT</option>
              <option value="ble">BLE teplomƒõr</option>
              <option value="none">Nepou≈æ√≠t</option>
            </select>
            <div class="mt8" id="eqOutdoorDallasRow">
              <select id="eqOutdoorDallas"></select>
            </div>
            <div class="mt8" id="eqOutdoorMqttRow">
  <div class="row2">
    <div style="grid-column:1/-1">
      <label class="mini">P≈ôednastaven√Ω teplomƒõr (z "Teplomƒõry")</label>
      <select id="eqOutdoorMqttPreset"></select>
    </div>
    <div><label class="mini">Topic</label><input id="eqOutdoorTopic" type="text" placeholder="nap≈ô. meteo/state"></div>
    <div><label class="mini">JSON kl√≠ƒç (voliteln√©)</label><input id="eqOutdoorJsonKey" type="text" placeholder="nap≈ô. tempC"></div>
  </div>
  <div class="mini mt4">Pokud payload nen√≠ ƒç√≠slo, nastav JSON kl√≠ƒç (nap≈ô. <code>tempC</code>). Bez kl√≠ƒçe se zkus√≠ autodetekce <code>tempC/temperature/temp</code>.</div>
</div>
            <div class="mt8" id="eqOutdoorBleRow">
              <select id="eqOutdoorBle"></select>
              <div class="mini mt4">Vy≈æaduje povolen√© BLE a dostupn√° data (nap≈ô. meteostanice).</div>
            </div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Teplota otopn√© vody</div>
          <div class="ioValue">
            <select id="eqFlowSource">
              <option value="dallas">DS18B20 (Dallas)</option>
              <option value="temp1">Vstup TEMP1 (legacy)</option>
              <option value="temp2">Vstup TEMP2 (legacy)</option>
              <option value="temp3">Vstup TEMP3 (legacy)</option>
              <option value="temp4">Vstup TEMP4 (legacy)</option>
              <option value="temp5">Vstup TEMP5 (legacy)</option>
              <option value="temp6">Vstup TEMP6 (legacy)</option>
              <option value="temp7">Vstup TEMP7 (legacy)</option>
              <option value="temp8">Vstup TEMP8 (legacy)</option>
              <option value="mqtt">MQTT</option>
              <option value="ble">BLE teplomƒõr</option>
              <option value="none">Nepou≈æ√≠t</option>
            </select>
            <div class="mt8" id="eqFlowDallasRow">
              <select id="eqFlowDallas"></select>
              <div class="hint mt4">Pro ≈ô√≠zen√≠ ventilu je pot≈ôeba m√≠t nastaven√Ω feedback senzor (flow).</div>
            </div>
            <div class="mt8" id="eqFlowMqttRow">
  <div class="row2">
    <div style="grid-column:1/-1">
      <label class="mini">P≈ôednastaven√Ω teplomƒõr (z "Teplomƒõry")</label>
      <select id="eqFlowMqttPreset"></select>
    </div>
    <div><label class="mini">Topic</label><input id="eqFlowTopic" type="text" placeholder="nap≈ô. boiler/flow"></div>
    <div><label class="mini">JSON kl√≠ƒç (voliteln√©)</label><input id="eqFlowJsonKey" type="text" placeholder="nap≈ô. tempC"></div>
  </div>
  <div class="mini mt4">Pokud payload nen√≠ ƒç√≠slo, nastav JSON kl√≠ƒç (nap≈ô. <code>tempC</code>). Bez kl√≠ƒçe se zkus√≠ autodetekce <code>tempC/temperature/temp</code>.</div>
</div>
            <div class="mt8" id="eqFlowBleRow">
              <select id="eqFlowBle"></select>
              <div class="mini mt4">Vy≈æaduje povolen√© BLE a dostupn√° data (nap≈ô. meteostanice).</div>
            </div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">3c ventil</div>
          <div class="ioValue">
            <select id="eqValveMaster"></select>
            <div class="hint mt4">Vyber master rel√© ventilu nakonfigurovan√©ho v <b>Funkce I/O</b> jako ‚Äû3c ventil (2 rel√©)‚Äú.</div>
          </div>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">K≈ôivka a ≈ô√≠zen√≠</div>
          <div class="cardSub">V√Ωpoƒçet c√≠lov√© teploty otopn√© vody + plynul√© korekce polohy</div>
        </div>
      </div>

      <div class="mt8">
        <canvas id="eqCurveCanvas" width="520" height="260" style="width:100%;max-width:720px;border:1px solid rgba(255,255,255,0.12);border-radius:12px;"></canvas>
        <div class="mini mt4">Graf: ekvitermn√≠ k≈ôivka (den/noc) + aktu√°ln√≠ bod (Tout ‚Üí Target).</div>
      </div>

      <div class="ioGrid">

        <div class="ioRow">
          <div class="ioLabel">Limity T<sub>flow</sub></div>
          <div class="ioValue">
            <div class="row2">
              <div><label class="mini">Min ¬∞C</label><input id="eqMinFlow" type="number" step="0.1"></div>
              <div><label class="mini">Max ¬∞C</label><input id="eqMaxFlow" type="number" step="0.1"></div>
            </div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Denn√≠ k≈ôivka</div>
          <div class="ioValue">
            <div class="row2">
              <div><label class="mini">Sklon</label><input id="eqSlopeDay" type="number" step="0.01"></div>
              <div><label class="mini">Posun</label><input id="eqShiftDay" type="number" step="0.1"></div>
            </div>
            <div class="hint mt4">Vzorec: <code>Tflow = (20 - Tout) * slope + 20 + shift</code></div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Noƒçn√≠ k≈ôivka</div>
          <div class="ioValue">
            <div class="row2">
              <div><label class="mini">Sklon</label><input id="eqSlopeNight" type="number" step="0.01"></div>
              <div><label class="mini">Posun</label><input id="eqShiftNight" type="number" step="0.1"></div>
            </div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">≈ò√≠zen√≠ ventilu</div>
          <div class="ioValue">
            <div class="row3">
              <div><label class="mini">Deadband ¬∞C</label><input id="eqDeadbandC" type="number" step="0.1"></div>
              <div><label class="mini">Krok %</label><input id="eqStepPct" type="number" step="1"></div>
              <div><label class="mini">Perioda s</label><input id="eqPeriodS" type="number" step="1"></div>
            </div>
            <div class="row2 mt8">
              <div><label class="mini">Min %</label><input id="eqMinPct" type="number" step="1"></div>
              <div><label class="mini">Max %</label><input id="eqMaxPct" type="number" step="1"></div>
            </div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Stav</div>
          <div class="ioValue">
            <div id="eqStatusBox" class="mono small"></div>
          </div>
        </div>

        <details class="mt12">
          <summary>Pokroƒçil√© (legacy refs)</summary>
          <div class="ioGrid mt8">
            <div class="ioRow">
              <div class="ioLabel">Day refs</div>
              <div class="ioValue">
                <div class="row4">
                  <div><label class="mini">Tout1</label><input id="eqHeatTout1" type="number" step="0.1"></div>
                  <div><label class="mini">Tflow1</label><input id="eqHeatTflow1" type="number" step="0.1"></div>
                  <div><label class="mini">Tout2</label><input id="eqHeatTout2" type="number" step="0.1"></div>
                  <div><label class="mini">Tflow2</label><input id="eqHeatTflow2" type="number" step="0.1"></div>
                </div>
              </div>
            </div>
            <div class="ioRow">
              <div class="ioLabel">Night refs</div>
              <div class="ioValue">
                <div class="row4">
                  <div><label class="mini">Tout1</label><input id="eqNightTout1" type="number" step="0.1"></div>
                  <div><label class="mini">Tflow1</label><input id="eqNightTflow1" type="number" step="0.1"></div>
                  <div><label class="mini">Tout2</label><input id="eqNightTout2" type="number" step="0.1"></div>
                  <div><label class="mini">Tflow2</label><input id="eqNightTflow2" type="number" step="0.1"></div>
                </div>
              </div>
            </div>
          </div>
        </details>

      </div>
    </div>
  </div>
</div>

<div class="tabPage" id="cfg-opentherm">
  <div class="grid2">
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">OpenTherm (kotel)</div>
          <div class="muted">Z√°kladn√≠ podpora (config + status API). Pro re√°lnou komunikaci je pot≈ôeba OpenTherm transceiver.</div>
        </div>
        <div>
          <button class="btn" id="btnSaveOpenTherm">Ulo≈æit</button>
        </div>
      </div>

      <div class="ioGrid">
        <div class="ioRow">
          <div class="ioLabel">Povolit</div>
          <div class="ioValue">
            <label class="switch"><input type="checkbox" id="otEnabled"><span class="slider"></span></label>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Re≈æim</div>
          <div class="ioValue">
            <select id="otMode">
              <option value="off">Vypnuto</option>
              <option value="manual">Manu√°ln√≠ setpoint</option>
              <option value="equitherm">Ekviterm ‚Üí setpoint</option>
            </select>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">GPIO (RX/TX)</div>
          <div class="ioValue">
            <div class="row2">
              <div><label class="mini">IN (RX)</label><input id="otInPin" type="number" min="-1" max="48" step="1" placeholder="-1 = nev√Ωbƒõr"></div>
              <div><label class="mini">OUT (TX)</label><input id="otOutPin" type="number" min="-1" max="48" step="1" placeholder="-1 = nev√Ωbƒõr"></div>
            </div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Polling</div>
          <div class="ioValue">
            <div class="row2">
              <div><label class="mini">Interval (ms)</label><input id="otPollMs" type="number" min="200" max="10000" step="100"></div>
              <div><label class="mini">CH enable</label>
                <label class="switch"><input type="checkbox" id="otChEnable"><span class="slider"></span></label>
              </div>
            </div>
          </div>
        </div>

        <div class="ioRow">
          <div class="ioLabel">Setpoint (manu√°l)</div>
          <div class="ioValue">
            <input id="otManualSetpoint" type="number" min="10" max="90" step="0.5">
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Stav</div>
          <div class="muted">Diagnostika komunikace</div>
        </div>
      </div>
      <div class="pad" id="otStatus"></div>
    </div>
  </div>
</div>

<div class="tabPage" id="cfg-iofun">

          <div class="grid2">
            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Funkce vstup≈Ø</div>
                  <div class="muted">Ka≈æd√©mu vstupu p≈ôi≈ôaƒè roli / ≈°ablonu (termostat, teplomƒõr, p≈ôep√≠naƒç re≈æimu‚Ä¶)</div>
                </div>
                <button class="btn" id="btnSaveInputFuncs">Ulo≈æit</button>
              </div>
              <div class="table" id="tblInputFuncs"></div>
            </div>

            <div class="card">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Funkce v√Ωstup≈Ø</div>
                  <div class="muted">Ka≈æd√©mu rel√© p≈ôi≈ôaƒè roli / ≈°ablonu (trojcestn√Ω ventil, ventil ON/OFF, ƒçerpadlo, topn√© tƒõleso‚Ä¶)</div>
                </div>
                <button class="btn" id="btnSaveOutputFuncs">Ulo≈æit</button>
              </div>
              <div class="table" id="tblOutputFuncs"></div>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Pozn√°mka k logice</div>
                <div class="muted">P≈ôi≈ôazen√© funkce slou≈æ√≠ firmwaru jako ‚Äûrole‚Äú I/O. Star≈°√≠ mapov√°n√≠ (Vstup ‚Üí Rel√©) a Re≈æimy z≈Øst√°v√° zachov√°no kv≈Øli zpƒõtn√© kompatibilitƒõ.</div>
              </div>
            </div>
            <div class="pad">
              <div class="muted">Jakmile bude firmware p≈ôipraven, m≈Ø≈æe pou≈æ√≠vat jen role I/O a re≈æimy se stanou nadstavbou.</div>
            </div>
          </div>
        </div>

<div class="tabPage" id="cfg-json">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Konfigurace jako JSON</div>
                <div class="muted">Zachov√° 100% kompatibilitu i pro polo≈æky, kter√© UI neukazuje.</div>
              </div>
              <div class="btnRow">
                <button class="btn ghost" id="btnFmtCfg">Form√°tovat</button>
                <button class="btn" id="btnSaveCfgJson">Ulo≈æit JSON</button>
              </div>
            </div>
            <textarea id="cfgJson" spellcheck="false" class="code" rows="18"></textarea>
          </div>
        </div>
      </section>

      <section class="page" id="page-mqtt">
        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">MQTT</div>
                <div class="muted">Nastaven√≠ p≈ôipojen√≠ + baseTopic</div>
              </div>
              <button class="btn" id="btnSaveMqtt">Ulo≈æit</button>
            </div>

            <div class="form">
              <label class="check"><input type="checkbox" id="mqttEnabled"> <span>MQTT enabled</span></label>

              <div class="row">
                <div class="field">
                  <label>Host</label>
                  <input id="mqttHost" placeholder="192.168.1.50" />
                </div>
                <div class="field">
                  <label>Port</label>
                  <input id="mqttPort" type="number" min="1" max="65535" placeholder="1883" />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>User</label>
                  <input id="mqttUser" placeholder="(voliteln√©)" />
                </div>
                <div class="field">
                  <label>Password</label>
                  <input id="mqttPass" placeholder="(voliteln√©)" />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Client ID</label>
                  <input id="mqttClientId" placeholder="espheat-xxxx" />
                </div>
                <div class="field">
                  <label>Base topic</label>
                  <input id="mqttBaseTopic" placeholder="espheat" />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>HA prefix</label>
                  <input id="mqttHaPrefix" placeholder="homeassistant" />
                </div>
                <div class="field">
                  <label>Akce</label>
                  <div class="btnRow">
                    <button class="btn ghost" id="btnMqttDiscovery">Republish discovery</button>
                  </div>
                </div>
              </div>

              <div class="note">
                Tip: v Home Assistant zkontroluj MQTT integraci a auto-discovery. N√°zvy rel√©/vstup≈Ø se berou z konfigurace.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Stav</div>
                <div class="muted">Rychl√Ω p≈ôehled nav√°z√°n√≠ spojen√≠</div>
              </div>
            </div>
            <div class="kv big">
              <div class="k">Wi‚ÄëFi</div><div class="v" id="stWifi">‚Äî</div>
              <div class="k">MQTT</div><div class="v" id="stMqtt">‚Äî</div>
              <div class="k">IP</div><div class="v" id="stIp">‚Äî</div>
              <div class="k">Uptime</div><div class="v" id="stUptime">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

      <section class="page" id="page-ble">
        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">BLE konfigurace</div>
                <div class="muted">Zapnut√≠, zabezpeƒçen√≠, meteo klient</div>
              </div>
              <button class="btn" id="btnSaveBle">Ulo≈æit</button>
            </div>

            <div class="form">
              <label class="check"><input type="checkbox" id="bleEnabled"> <span>BLE enabled</span></label>
              <div class="row">
                <div class="field">
                  <label>Device name</label>
                  <input id="bleDeviceName" placeholder="ESP-HeatControl" />
                </div>
                <div class="field">
                  <label>Advertise</label>
                  <select id="bleAdvertise">
                    <option value="true">true</option>
                    <option value="false">false</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Security mode</label>
                  <select id="bleSecurityMode">
                    <option value="0">0 (none)</option>
                    <option value="1">1 (passkey)</option>
                  </select>
                </div>
                <div class="field">
                  <label>Passkey</label>
                  <input id="blePasskey" type="number" min="0" max="999999" placeholder="123456" />
                </div>
              </div>

              <label class="check"><input type="checkbox" id="bleAllowlist"> <span>Allowlist enforced</span></label>

              <hr class="sep" />

              <label class="check"><input type="checkbox" id="meteoEnabled"> <span>Meteo enabled</span></label>

              <div class="row">
                <div class="field">
                  <label>Meteo MAC</label>
                  <input id="meteoMac" placeholder="AA:BB:CC:DD:EE:FF" />
                </div>
                <div class="field">
                  <label>Scan (ms)</label>
                  <input id="meteoScanMs" type="number" min="1000" step="1000" placeholder="20000" />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Reconnect (ms)</label>
                  <input id="meteoReconnectMs" type="number" min="1000" step="1000" placeholder="30000" />
                </div>
              </div>
            </div>
          </div>

          <div class="card" id="blePairCard">
            <div class="cardHead">
              <div>
                <div class="cardTitle">P√°rov√°n√≠ & Allowlist</div>
                <div class="muted">Okno pro p≈ôid√°n√≠ za≈ô√≠zen√≠ do allowlistu</div>
              </div>
            </div>

            <div class="form">
              <div class="row">
                <div class="field">
                  <label>Pairing (sekundy)</label>
                  <input id="pairSeconds" type="number" min="10" max="600" value="120" />
                </div>
                <div class="field">
                  <label>Role (hint)</label>
                  <input id="pairRole" placeholder="nap≈ô. meteo" />
                </div>
                <div class="field">
                  <label>Akce</label>
                  <div class="btnRow">
                    <button class="btn" id="btnStartPair">Start</button>
                    <button class="btn ghost" id="btnStopPair">Stop</button>
                  </div>
                </div>
              </div>

              <div class="kv">
                <div class="k">Stav</div><div class="v" id="bleState">‚Äî</div>
                <div class="k">P√°rov√°n√≠</div><div class="v" id="blePairState">‚Äî</div>
                <div class="k">Meteo</div><div class="v" id="bleMeteoState">‚Äî</div>
              </div>

              <div class="table" id="tblBlePaired"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="page" id="page-rules">
        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Rule engine</div>
                <div class="muted">Editor pravidel + pokroƒçil√Ω JSON</div>
              </div>
              <div class="btnRow">
                <button class="btn ghost" id="btnAddRule">+ Pravidlo</button>
                <button class="btn ghost" id="btnFmtRules">Form√°tovat</button>
                <button class="btn" id="btnSaveRules">Ulo≈æit</button>
              </div>
            </div>

            <div class="rtabs" style="padding: 0 14px 10px">
              <button class="rtab active" data-rtab="editor">Editor</button>
              <button class="rtab" data-rtab="json">JSON</button>
            </div>

            <div class="tabPage active" id="rtab-editor">
              <div class="form">
                <label class="check"><input type="checkbox" id="rulesEnabled" /> Rule engine enabled</label>
                <label class="check"><input type="checkbox" id="rulesDefaultOff" /> Default OFF pro ≈ô√≠zen√° rel√© (fallback)</label>
              </div>
              <div class="table" id="rulesTable"></div>
              <div class="note">Tip: Klikni na ‚ÄûUpravit‚Äú u pravidla. Pro slo≈æitƒõj≈°√≠ podm√≠nky/akce pou≈æij z√°lo≈æku JSON.</div>
            </div>

            <div class="tabPage" id="rtab-json">
              <textarea id="rulesJson" spellcheck="false" class="code" rows="18"></textarea>
            </div>
          </div>

          <!-- Modal: Rule editor -->
          <div class="modal hidden" id="ruleModal">
            <div class="modalBack" data-close="1"></div>
            <div class="modalCard">
              <div class="modalHead">
                <div>
                  <div class="cardTitle" id="ruleModalTitle">Pravidlo</div>
                  <div class="muted">Z√°kladn√≠ editor pro nejƒçastƒõj≈°√≠ sc√©n√°≈ôe</div>
                </div>
                <button class="btn ghost" id="btnRuleClose">Zav≈ô√≠t</button>
              </div>

              <div class="form">
                <div class="row">
                  <div class="field"><label>N√°zev</label><input id="ruleName" /></div>
                  <div class="field"><label>Popis</label><input id="ruleDesc" /></div>
                </div>

                <div class="row">
                  <div class="field"><label>Enabled</label><select id="ruleEnabled"><option value="true">true</option><option value="false">false</option></select></div>
                  <div class="field"><label>Priority</label><input id="rulePriority" type="number" step="1" /></div>
                  <div class="field"><label>Stop on match</label><select id="ruleStopOnMatch"><option value="false">false</option><option value="true">true</option></select></div>
                </div>

                <div class="row">
                  <div class="field"><label>Debounce (ms)</label><input id="ruleDebounceMs" type="number" step="10" min="0" /></div>
                  <div class="field"><label>Min ON (ms)</label><input id="ruleMinOnMs" type="number" step="100" min="0" /></div>
                  <div class="field"><label>Min OFF (ms)</label><input id="ruleMinOffMs" type="number" step="100" min="0" /></div>
                </div>

                <hr class="sep" />

                <div class="row">
                  <div class="field">
                    <label>WHEN (Podm√≠nky)</label>

                    <div class="row" style="padding:0">
                      <div class="field">
                        <label>Oper√°tor</label>
                        <select id="ruleWhenOp">
                          <option value="AND">AND</option>
                          <option value="OR">OR</option>
                        </select>
                      </div>
                      <div class="field" style="display:flex;align-items:flex-end">
                        <button class="btn" id="btnRuleAddCond">+ Podm√≠nka</button>
                      </div>
                    </div>

                    <div id="ruleWhenList" class="kv" style="gap:10px"></div>
                    <div class="note">Podporovan√© typy: Input, Time (HH:MM), MQTT (topic + hodnota). Kombinace p≈ôes AND/OR.</div>
                  </div>
                </div>

                <div class="row">
                  <div class="field">
                    <label>THEN (Akce)</label>

                    <div class="row" style="padding:0">
                      <div class="field" style="display:flex;align-items:flex-end">
                        <button class="btn" id="btnRuleAddAction">+ Akce</button>
                      </div>
                    </div>

                    <div id="ruleThenList" class="kv" style="gap:10px"></div>
                    <div class="note">Podporovan√© akce: Relay set. Ostatn√≠ typy jsou p≈ôipraven√© v JSON (pulse / mqtt_publish).</div>
                  </div>
                </div>

                <div class="btnRow" style="padding: 0 14px 14px">
                  <button class="btn" id="btnRuleSave">Ulo≈æit do editoru</button>
                  <button class="btn bad" id="btnRuleDelete">Smazat</button>
                </div>
              </div>
            </div>
          </div><div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Stav Rule engine</div>
                <div class="muted">Runtime info (poƒçty, enabled, ‚Ä¶)</div>
              </div>
              <button class="btn ghost" id="btnReloadRules">Naƒç√≠st</button>
            </div>
            <pre class="pre" id="rulesStatus">‚Äî</pre>
          </div>
        </div>
      </section>

      <section class="page" id="page-files">
        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Soubory v LittleFS</div>
                <div class="muted">Seznam / maz√°n√≠</div>
              </div>
              <button class="btn ghost" id="btnRefreshFiles">Obnovit</button>
            </div>
            <div class="table" id="tblFiles"></div>
          </div>

          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Upload souboru</div>
                <div class="muted">Nahraje do LittleFS p≈ôes /api/fs/upload</div>
              </div>
            </div>
            <form id="uploadForm" class="form">
              <div class="row">
                <div class="field">
                  <label>Soubor</label>
                  <input id="filePick" type="file" />
                </div>
                <div class="field">
                  <label>C√≠l</label>
                  <input id="filePath" placeholder="/index.html" />
                </div>
              </div>
              <button class="btn" type="submit">Nahr√°t</button>
              <div class="muted" id="uploadHint">Pozn.: nƒõkter√© upload implementace ignoruj√≠ c√≠lovou cestu a pou≈æ√≠vaj√≠ n√°zev souboru.</div>
            </form>
          </div>
        </div>

        <div class="note">
          Tip: Pro nahr√°n√≠ cel√© web UI slo≈æky je pohodlnƒõj≈°√≠ LittleFS uploader v Arduino IDE (data upload).
        </div>
      </section>

      <section class="page" id="page-system">
        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Restart</div>
                <div class="muted">Po≈°le /api/reboot</div>
              </div>
            </div>
            <div class="form">
              <button class="btn bad" id="btnReboot">Restartovat za≈ô√≠zen√≠</button>
              <div class="muted">Po restartu se str√°nka m≈Ø≈æe na chv√≠li odpojit.</div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead">
              <div>
                <div class="cardTitle">Rychl√© odkazy</div>
                <div class="muted">Pomocn√© str√°nky</div>
              </div>
            </div>
            <div class="form">
              <a class="link" href="/update.html">update.html</a>
              <a class="link" href="/ble.html">ble.html</a>
            </div>
          </div>
        </div>
      </section>

<section class="page" id="page-ota">
  <div class="card">
    <div class="cardHead">
      <div>
        <div class="cardTitle">OTA update</div>
        <div class="muted">Webov√Ω upload firmware p≈ôes str√°nku /ota.html.</div>
      </div>
    </div>
    <div style="height:70vh; border-radius:14px; overflow:hidden; border:1px solid var(--line);">
      <iframe src="/ota.html" style="width:100%;height:100%;border:0"></iframe>
    </div>
  </div>
</section>

      <div class="toast" id="toast" role="status" aria-live="polite"></div>
    </main>
  </div>

  <!-- Days picker modal -->
  <div class="modal hidden" id="modalDays" aria-hidden="true">
    <div class="modalBack" data-close="1"></div>
    <div class="modalCard" style="width:min(520px, calc(100vw - 32px))">
      <div class="modalHead">
        <div>
          <div class="cardTitle">V√Ωbƒõr dn≈Ø</div>
          <div class="muted">Klikni na dny, kter√© maj√≠ b√Ωt aktivn√≠ (Po=1 .. Ne=7)</div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="daysClose">Zav≈ô√≠t</button>
        </div>
      </div>
      <div class="pad">
        <div class="rtabs" style="flex-wrap:wrap">
          <button class="rtab" id="daysAll">V≈°e</button>
          <button class="rtab" id="daysWeek">Po‚ÄìP√°</button>
          <button class="rtab" id="daysWeekend">So‚ÄìNe</button>
          <button class="rtab" id="daysNone">Nic</button>
        </div>

        <div class="grid2" style="grid-template-columns:repeat(7,1fr); gap:10px; margin-top:10px">
          <label class="check" style="justify-content:center"><input type="checkbox" data-day="1"> <span>Po</span></label>
          <label class="check" style="justify-content:center"><input type="checkbox" data-day="2"> <span>√öt</span></label>
          <label class="check" style="justify-content:center"><input type="checkbox" data-day="3"> <span>St</span></label>
          <label class="check" style="justify-content:center"><input type="checkbox" data-day="4"> <span>ƒåt</span></label>
          <label class="check" style="justify-content:center"><input type="checkbox" data-day="5"> <span>P√°</span></label>
          <label class="check" style="justify-content:center"><input type="checkbox" data-day="6"> <span>So</span></label>
          <label class="check" style="justify-content:center"><input type="checkbox" data-day="7"> <span>Ne</span></label>
        </div>

        <div class="hr"></div>
        <div class="actions" style="justify-content:flex-end">
          <button class="btn ghost" id="daysCancel">Zru≈°it</button>
          <button class="btn" id="daysOk">Pou≈æ√≠t</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/app.js?v=2"></script>
  <script src="/equitherm.js?v=3"></script>
  <script src="/iofunc.js?v=3"></script>
  <script src="/temps_tab.js?v=1"></script>
  <script src="/opentherm.js?v=1"></script>
  <script src="/buzzer.js?v=1"></script>
  <script src="/valve_calib.js?v=2"></script>
  <script src="/time_ntp.js?v=1"></script>
  <script src="/schedules.js?v=1"></script>
  <script src="/dash_v2.js?v=1"></script>

</body>
</html>
